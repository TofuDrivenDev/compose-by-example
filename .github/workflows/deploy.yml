name: "🚀 Deploy Pages"
run-name: "${{ inputs.ref }} #${{ inputs.commit_hash }}"


on:
  workflow_dispatch:
    inputs:
      commit_hash:
        required: false
        type: string
      ref:
        required: true
        type: string
        default: 'refs/heads/main'


permissions:
  contents: read
  pages: write
  id-token: write


jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: "📥 Checkout Code"
        uses: actions/checkout@v4
        with:
          repository: TofuDrivenDev/kmp-monorepo
          ref: ${{ inputs.ref }}
          token: ${{ secrets.KMP_MONOREPO_PAT }}

      - name: "⚙️ Setup JDK"
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      
      - name: "⚙️ Setup Gradle"
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: 8.12.1

      - name: "🛠️ Build Wasm Binaries"
        run: gradle :appComposeByExample:wasmJsBrowserDistribution -DGITHUB_PAT=${{ github.token }}
        
      - name: "📋 Move Wasm Binaries"
        env:
          WASM_FROM: ./appComposeByExample/build/dist/wasmJs/productionExecutable
          WASM_TO: ./appComposeByExample/web/public/wasm
        run: |
          rm -rf ${{ env.WASM_TO }}
          mkdir -p ${{ env.WASM_TO }}
          cp ${{ env.WASM_FROM }}/*.js \
             ${{ env.WASM_FROM }}/*.js.map \
             ${{ env.WASM_FROM }}/*.wasm \
             ${{ env.WASM_TO }}

      - name: "⚙️ Setup NPM"
        working-directory: ./appComposeByExample/web
        run: npm ci

      - name: "🛠️ Build Next.js App"
        working-directory: ./appComposeByExample/web
        run: npm run build

      - name: "⚙️ Setup Pages"
        uses: actions/configure-pages@v5

      - name: "📤 Upload Artifact to Pages"
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./appComposeByExample/web/out

      - name: "🚀 Deploy Pages"
        id: deployment
        uses: actions/deploy-pages@v4
        
